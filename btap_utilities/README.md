# btap_utilities
Helper files for the BTAP development environment

## Creating an OpenStudio-Server AMI
To create an AMI of OpenStudio Server, Create a new Ubuntu instance on Amazon with atleast 2 cores (4 cores recommended) from the `c` series (e.g. `c5.xlarge`). Atleast make sure that there is enough disk space.

Copy `create_ami_image_on_aws.sh` file from this repo over to that instance, and edit `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`, `VERSION`, `EXTENSION`, `SERVER_BRANCH`, and `SERVER_SHA`. Then execute the script. When prompted for docker username and password, enter them as requested. 

## Running the custom created AMI for OpenStudio-Server
Follow the instructions posted on [canmet-energy/start_aws_server](https://github.com/canmet-energy/start_aws_server) repository.

## Using JSON Diff utility (json_compare.rb)
This utility is used to compare two similar simulations.json files. The simulations.json file is generated by the BTAP Download button from the custom nrcan's Openstudio Server. the BTAP download button uses the [gather_results.rb](https://github.com/canmet-energy/btap_gather_results).

This script also determines if the value of each hash is numeric, and rounds them before the comparision. This would eliminate some of the changes caused by the inaccuracies by floating point numbers. 

Additionally, This script also determines what precision (number of decimal points) to use. For example, the default precision for comparision is 5 decimal places. But for numbers with less than 5 decimal places, the precision would be set to one less than the number of decimal places. The number of decimal points or precision used will be reported in the output.

```ruby
2.3456784512 => 2.34568
2.34 => 2.3
```

The old file can be specified for the variable 
 
```ruby
# old json file
json_243 = JSON.parse(File.read("./243simulations_2011.json"))
```

The new file can be specified for the variable 
 
```ruby
# new json file
json_260 = JSON.parse(File.read("./260simulations_2011.json"))
```

The key names that are to be ignored can be specified by modifying the `exclude` variable. The `note` key was added, so that the notes generated by the quto_costing can be ignored.

```ruby
# keys to exclude
# not including the key called 'name' because it is used for a lot of other things. 
# But the building name will be ignored. It has been harcoded
exclude = ['run_uuid', 'analysis_id', 'openstudio_version', 'date', 'analysis_name', 'note']
```

#### Sample diff.txt output file

+ Each Archetype and city pair is divided by a line `_________`. 
+ The number within the square bracket states the tollerance. 
+ The `Key` states the location of the values that was compared.
+ The `new_value` states the value that is compared which is present within the file defined by the `json_260` variable
+ The `old_value` states the value that is compared which is present within the file defined by the `json_243` variable
+ The `Maximum percent difference` gets the maximum of the following
  + `((new_value - old_value)/new_value).abs * 100.0` or
  + `((new_value - old_value)/old_value).abs * 100.0`


```text

Building: Outpatient
City: BC_Comox Valley AP
Diff: [tolerance] message
[1] Key:['building']['end_uses']['heat_rejection_water_m3']
new_value:
15542.64
old_value:
15542.51
Maximum percent difference:
0.0008364157397949214

[1] Key:['building']['end_uses']['total_end_uses_water_m3']
new_value:
16627.24
old_value:
16627.11
Maximum percent difference:
0.0007818556562205857

[5] Key:['building']['end_uses_eui']['heat_rejection_water_m3_per_m2']
new_value:
4.085859048482617
old_value:
4.085824874000269
Maximum percent difference:
0.0008364157398291505

[5] Key:['building']['end_uses_eui']['total_end_uses_water_m3_per_m2']
new_value:
4.3709793835083435
old_value:
4.3709452090259955
Maximum percent difference:
0.0007818556562416421

________________________________________
Building: Outpatient
City: BC_Prince George Intl AP
Diff: [tolerance] message
[1] Key:['building']['unmet_hours']['cooling']
new_value:
59.5
old_value:
59.25
Maximum percent difference:
0.42194092827004215

________________________________________
```

#### Sample diff_percent.json output file

This file shows the diff sorted by the `percent_diff` key (reported as `Maximum percent difference` in `diff.txt` above)
+ `percent_diff_1` = `(new_value - old_value)/old_value * 100.0`
+ `percent_diff_2` = `(new_value - old_value)/new_value * 100.0`
+ `percent_diff` = `[percent_diff_1, percent_diff_2].max`

```json
[
  {
    "Building": "Outpatient",
    "City": "NS_Sable Island Natl Park",
    "diff_data": {
      "message": "[1] Key:['building']['unmet_hours']['cooling']\nnew_value:\n47.75\nold_value:\n47.5\n",
      "percent_diff_1": 0.5263157894736842,
      "percent_diff_2": 0.5235602094240838,
      "percent_diff": 0.5263157894736842,
      "key": "['building']['unmet_hours']",
      "new_value": "47.75",
      "old_value": "47.5"
    }
  },
  {
    "Building": "Outpatient",
    "City": "BC_Prince George Intl AP",
    "diff_data": {
      "message": "[1] Key:['building']['unmet_hours']['cooling']\nnew_value:\n59.5\nold_value:\n59.25\n",
      "percent_diff_1": 0.42194092827004215,
      "percent_diff_2": 0.42016806722689076,
      "percent_diff": 0.42194092827004215,
      "key": "['building']['unmet_hours']",
      "new_value": "59.5",
      "old_value": "59.25"
    }
  },
  {
    "Building": "Outpatient",
    "City": "MB_The Pas AP",
    "diff_data": {
      "message": "[5] Key:['building']['economics']['total_cost_per_m2']\nnew_value:\n20.422528694908415\nold_value:\n20.423138577977987\n",
      "percent_diff_1": 0.002986235769998749,
      "percent_diff_2": 0.002986324948702576,
      "percent_diff": 0.002986324948702576,
      "key": "['building']['economics']",
      "new_value": "20.422528694908415",
      "old_value": "20.423138577977987"
    }
  },
  ...
]
```